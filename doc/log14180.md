# Kostal Wechselrichter ModbusTCP

Dieser Logikbaustein liest regelmäßig Werte aus dem Wechselrichter des Herstellers *Kostal* ein. Getestet wurde dies mit dem *Kostal Plenticore Plus 10* und BYD-Akku.
Er sollte auch mit einem PIKO IQ und PIKO CI funktionieren, NICHT aber mit PIKO MP oder PIKO 12-20. - Für letzteren steht ein anderer Baustein zur Verfügung!
Bitte nutzt eine aktuelle Firmware des Wechselrichters, da ansonsten ggf. Modbus-Register fehlen. 
Ist kein KSEM eingebunden, so sind die Verbrauchswerte nicht verfügbar.

**Dieser Baustein wird nicht mit Wechselrichtern anderer Hersteller funktionieren!**

## Eingänge

| Nummer | Datentyp | Default    | Beschreibung                                                                                                                                                            |
|--------|----------|------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1      | Zahl     | 0          | Schaltet den Baustein aus oder an. Dies funktioniert zur Laufzeit oder auch statisch, in dem der Wert entsprechend im Logikeditor geändert wird. 0 = Aus, 1 = an        |
| 2      | Zahl     | 5 Sekunden | Ist die Frequenz, wie oft der Baustein den Wechselrichter abfragt. Kleinere Werte erhöhen die Last auf HS und WR.                                                       | 
| 3      | Text     | 127.0.0.1  | Die IP-Adresse für den Wechselrichter. Hostname aktuell nicht implementiert. Unterstützt keine dynamischen Änderungen!                                                  |
| 4      | Zahl     | 1502       | Der TCP-Port für Modbus. Eigentlich 502, Kostal hat diesen aber auf 1502 festgelegt. Muss in der Regel nicht geändert werden. Unterstützt keine dynamischen Änderungen! |
| 5      | Zahl     | 71         | Die Modbus Unit ID. Kostal setzt diese in der Regel auf 71. Zu finden ist diese in den Wechselrichter-Einstellungen, wo auch Modbus TCP aktiviert wird.                 |
| 6      | Zahl     | 0          | Aktiviert die Debug-Ausgabe in der HS-Debug-Ansicht. Es sollte nur ein Baustein auf Debug stehen!                                                                       |

## Ausgänge

Alle Ausgänge sind SBC - Send by change - und werden daher nur gesendet, wenn auch eine Änderung eingetreten ist.
DPT ist eine Empfehlung. 

| Nummer | DPT                  | Modbus-Reg      | Einheit | Abruf-Beschränkungen | Beschreibung                                                                                                                                                                                                                                                         |
|--------|----------------------|-----------------|---------|----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1      | 7.001 / Signed Int   | 106             | W       | nur mit Batterie     | Aktuelle selbst-benötigte Leistung aus der Batterie                                                                                                                                                                                                                  |
| 2      | 7.001 / Signed Int   | 108             | W       | ---                  | Aktuelle selbst-benötigte Leistung aus dem Stromnetz                                                                                                                                                                                                                 |
| 3      | 7.001 / Signed Int   | 116             | W       | ---                  | Aktuelle selbst-benötigte Leistung aus dem PV-Generator                                                                                                                                                                                                              |
| 4      | 7.001 / Signed Int   | --- (berechnet) | W       | ---                  | Aktuelle Summe aller selbst-benötigte Leistungen aller Quellen                                                                                                                                                                                                       |
| 5      | 9.xxx / Float        | 252             | W       | ---                  | Gesamtleistung aus dem Stromnetz (negativ: Einspeisung ins Stromnetz)                                                                                                                                                                                                |
| 6      | 9.xxx / Float        | --- (berechnet) | W       | ---                  | Gesamtleistung aus dem PV-Generator. Die Summe aus Batterie-Ladeleistung, Haus-Verbrauch und Einspeisung. Damit ist die Berechnung auf der AC-Seite                                                                                                                  |
| 7      | 7.001 / Signed Int   | ???             | W       | ---                  | Leistungs-Limit, die der WR gerade unterliegt                                                                                                                                                                                                                        |
| 8      | 9.xxx / Float        | 575             | W       | ---                  | Leistung, die der Inverter aktuell AC/DC umwandelt aus dem PV-Generator                                                                                                                                                                                              |
| 9      | 6.xxx / Signed Int   | 56              | W       | ---                  | Wechselrichter Status als Ganzzahl. Bedeutung siehe Handbuch. Eigentlich immer positiv, Nicht lesbar ist aber -1                                                                                                                                                     |
| 10     | 14-Byte Text         | (56)            | ---     | ---                  | Wechselrichter Status als Text - Englisch. Texte angelehnt an das Handbuch. "---" wenn kein Wert ermittelt werden kann                                                                                                                                               |
| 11     | 9.xxx / Float        |                 | Megaohm | ---                  | Isolations-Messung                                                                                                                                                                                                                                                   |
| 12     |                      |                 | ---     | ---                  | Cos Phi                                                                                                                                                                                                                                                              |
| 13     |                      |                 | hz      | ---                  | AC-Netzfrequenz                                                                                                                                                                                                                                                      |
| 14     | 9.xxx / Float        |                 | V       | ---                  | AC L1: Spannung                                                                                                                                                                                                                                                      |
| 15     | 9.xxx / Float        |                 | A       | ---                  | AC L1: Strom (0, wenn WR=Off)                                                                                                                                                                                                                                        |
| 16     | 9.xxx / Float        |                 | W       | ---                  | AC L1: Leistung (0, wenn WR=Off)                                                                                                                                                                                                                                     |
| 17     | 9.xxx / Float        |                 | V       | ---                  | AC L2: Spannung                                                                                                                                                                                                                                                      |
| 18     | 9.xxx / Float        |                 | A       | ---                  | AC L2: Strom (0, wenn WR=Off)                                                                                                                                                                                                                                        |
| 19     | 9.xxx / Float        |                 | W       | ---                  | AC L2: Leistung (0, wenn WR=Off)                                                                                                                                                                                                                                     |
| 20     | 9.xxx / Float        |                 | V       | ---                  | AC L3: Spannung                                                                                                                                                                                                                                                      |
| 21     | 9.xxx / Float        |                 | A       | ---                  | AC L3: Strom (0, wenn WR=Off)                                                                                                                                                                                                                                        |
| 22     | 9.xxx / Float        |                 | W       | ---                  | AC L3: Leistung (0, wenn WR=Off)                                                                                                                                                                                                                                     |
| 24     | 9.xxx / Float        | 320             | kWh     | ---                  | Gesamtertrag aus PV-Generator ***Zu beachten*** *ist hier, dass nur Leistung AC/DC hier einfließen. Das Laden der Batterie wird durch Kostal nicht mitgezählt, erst der Abruf der Leistung mit der verbundenen Wandlung. Unklar: Verhalten beim Laden aus Stromnetz* |
| 25     | 9.xxx / Float        | 322             | kWh     | ---                  | Heutiger Ertrag aus PV-Generator. Siehe Hinweis beim Gesamtertrag aus PV-Generator                                                                                                                                                                                   |
| 26     | 9.xxx / Float        | 326             | kWh     | ---                  | Ertrag aus PV-Generator von diesem Monat. Siehe Hinweis beim Gesamtertrag aus PV-Generator                                                                                                                                                                           |
| 27     | 9.xxx / Float        | 324             | kWh     | ---                  | Ertrag aus PV-Generator von diesem Jahr. Siehe Hinweis beim Gesamtertrag aus PV-Generator                                                                                                                                                                            |
| 28     | 9.xxx / Float        | 266             | V       | ---                  | Spannung des 1. MPP-Trackers                                                                                                                                                                                                                                         |
| 29     | 9.xxx / Float        | 258             | A       | ---                  | Strom des 1. MPP-Trackers (0, wenn WR=Off)                                                                                                                                                                                                                           |
| 30     | 9.xxx / Float        | 258             | W       | ---                  | Leistung des 1. MPP-Trackers (0, wenn WR=Off)                                                                                                                                                                                                                        |
| 31     | 9.xxx / Float        | 276             | V       | ---                  | Spannung des 2. MPP-Trackers                                                                                                                                                                                                                                         |
| 32     | 9.xxx / Float        | 268             | A       | ---                  | Strom des 2. MPP-Trackers (0, wenn WR=Off)                                                                                                                                                                                                                           |
| 33     | 9.xxx / Float        | 268             | W       | ---                  | Leistung des 2. MPP-Trackers (0, wenn WR=Off)                                                                                                                                                                                                                        |
| 34     | 9.xxx / Float        | 286             | V       | nur ohne Batterie    | Spannung des 3. MPP-Trackers                                                                                                                                                                                                                                         |
| 35     | 9.xxx / Float        | 278             | A       | nur ohne Batterie    | Strom des 3. MPP-Trackers (0, wenn WR=Off)                                                                                                                                                                                                                           |
| 36     | 9.xxx / Float        | 278             | W       | nur ohne Batterie    | Leistung des 3. MPP-Trackers (0, wenn WR=Off)                                                                                                                                                                                                                        |
| 37     | 13.xxx / Big Float   | 1062            | W       | ---                  | Die Leistung aller PV-Eingänge auf der DC-Seite. (Vergleiche mit Ausgang 6)                                                                                                                                                                                          |
| 38     | 1.xxx / Boolean      | 208             | ---     | nur mit Batterie     | Batterie Einsatzbereit: 1 = ja, 0 = Nein/Fehler                                                                                                                                                                                                                      |
| 39     | 7.001 / Signed Int   |                 | Wh      | nur mit Batterie     | Kapazität der Batterie                                                                                                                                                                                                                                               | 
| 40     | 5.xxx / Unsigned Int | 514             | %       | nur mit Batterie     | Ladestand der Batterie                                                                                                                                                                                                                                               |
| 41     | 9.xxx / Float        | 582             | W       | nur mit Batterie     | Gesamtleistung aus der Batterie (negativ: Laden der Batterie)                                                                                                                                                                                                        |
| 42     | 9.xxx / Float        | 214             | C       | nur mit Batterie     | Spannung der Batterie                                                                                                                                                                                                                                                |
| 43     | 9.xxx / Float        | 214             | °C      | nur mit Batterie     | Temperatur der Batterie                                                                                                                                                                                                                                              |
| 44     | 7.xxx / Unsigned Int | 194             | ---     | nur mit Batterie     | Anzahl der Ladezyklen der Batterie                                                                                                                                                                                                                                   |
| 45     | 13.xxx / Big Float   | 1046            | kWh     | nur mit Batterie     | Gesamtenergie DC, die zum Laden der Batterie verwendet wurde (DC-side to battery)                                                                                                                                                                                    |
| 46     | 13.xxx / Big Float   | 1048            | kWh     | nur mit Batterie     | Gesamtenergie DC, die aus der Batterie entladen wurde (DC-side from battery)                                                                                                                                                                                         |
| 47     | 13.xxx / Big Float   | 1050            | kWh     | nur mit Batterie     | Gesamtenergie AC, die zum Laden der Batterie verwendet wurde (AC-side to battery)                                                                                                                                                                                    |
| 48     | 13.xxx / Big Float   | 1052            | kWh     | nur mit Batterie     | Gesamtenergie AC, die aus der Batterie entladen wurde (battery to grid)                                                                                                                                                                                              |
| 49     | 13.xxx / Big Float   | 1054            | kWh     | nur mit Batterie     | Gesamtenergie AC, die aus zum Laden der Batterie aus dem Stromnetz entnommen wurde (grid to battery)                                                                                                                                                                 |
| 50     | 13.xxx / Big Float   | 1056            | kWh     |                      | Gesamtenergie aller DC-Eingänge des PV-Generators                                                                                                                                                                                                                    |
| 51     | 13.xxx / Big Float   | 1058            | kWh     |                      | Gesamtenergie des 1. DC-Eingangs / MPP-Trackers (des PV-Generators)                                                                                                                                                                                                  |
| 52     | 13.xxx / Big Float   | 1060            | kWh     |                      | Gesamtenergie des 2. DC-Eingangs / MPP-Trackers (des PV-Generators)                                                                                                                                                                                                  |
| 53     | 13.xxx / Big Float   | 1062            | kWh     |                      | Gesamtenergie des 3. DC-Eingangs / MPP-Trackers (des PV-Generators)                                                                                                                                                                                                  |
| 54     | 13.xxx / Big Float   | 1062            | kWh     |                      | Gesamtenergie der AC-Seite ins Netz                                                                                                                                                                                                                                  |

# Debug-Mode

Der Logikbaustein zeigt auch die RAW-Werte und weitere interne Werte im Debug-Fenster des Homeservers an, wenn der Eingang6 auf 1 gesetzt wird. Dort sind auch die letzten Fehler einzusehen:

1. Homeserver hslist aufrufen - https://<HS IP>>/hslist
2. Listenschlüssel: `debug`, Username und Passwort von einem admin-User eingeben.
3. Unter *HSL2.0* oder *kostalInverterModbusTCP14180* die Fehler suchen oder die Werte überprüfen.

# Haftung / Gewährleistung

Es wird weder eine Haftung noch eine Gewährleistung übernommen. Für den Betrieb ist der Anlagenbetreiber bzw. Integrator verantwortlich.

# Sourcecode / Weiterführende Doku

* Der Sourcecode ist auf Github zu finden: [hs_kostalInverterModbusTCP](https://github.com/SvenBunge/hs_kostalInverterModbusTCP)
* Der Baustein wird im KNX-Forum diskutiert: [Thread](https://knx-user-forum.de/forum/%C3%B6ffentlicher-bereich/knx-eib-forum/1559910-logikbaustein-kostal-wechselrichter-via-modbus-tcp-abfragen)

# Lizenz & faire Nutzung

* Der Baustein wird unter der LGPL 2.1 frei zur Verfügung gestellt.
* Die Nutzung des Logikbausteins ist für Endverbraucher frei, wenn sie diese selbst und selbstständig in Betrieb nehmen und konfigurieren. - Integratoren haben eine angemessene Aufwandsentschädigung pro Installation zu zahlen!
* Freie Software heißt nicht freie Wartung & Support und geschieht auf freiwilliger Basis
* Es wird keine Gewährleistung noch Haftung für Schäden aus der Nutzung des Bausteins übernommen
* Er enthält folgende weiteren Libraries und Lizenzen
  * pymodbus - Own [License](https://github.com/pymodbus-dev/pymodbus/blob/dev/LICENSE) 
  * pyserial - [BSD-3-Clause License](https://github.com/pyserial/pyserial/blob/master/LICENSE.txt)
  * six - [MIT License](https://github.com/benjaminp/six/blob/master/LICENSE)
